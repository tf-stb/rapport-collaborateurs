<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapport d'activité des collaborateurs</title>
    <link rel="shortcut icon" href="https://tf-stb.github.io/pdf/icon.png" type="image/x-icon" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- SheetJS (for reading Excel files) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        canvas {
            max-width: 100%;
            height: auto;
            margin-top: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            margin-top: 40px;
            margin-bottom: 20px;
        }
        .date-range {
            
            font-size: 1.2em;
            margin-top: 20px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .chart-container {
            display: flex;
            flex-direction: column;
        }
        .chart-wrapper {
            width: 100%;
            margin-bottom: 20px;
        }
        .doughnutChart{
            max-width: 768px;
            margin: 0 auto;
            margin-top: 50px;
            margin-bottom: 50px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
        }
        th {
            background-color: #f4f4f4;
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="https://durelectransfo.fr/wp-content/uploads/2017/11/Stef_logo-1000x228.png" class="py-3 " height="70" />
        <h1>Rapport d'activité des collaborateurs <span class="small text-muted">(démo)</span></h1>
        <div class="row">
            <div class="col-md-12">
                <!-- File Input -->
                <input type="file" id="fileInput" class="form-control mb-3" accept=".xlsx, .xls">
                <!-- Date Range Display -->
                <div id="dateRange" class="date-range"></div>
                <!-- Chart Containers -->
                <div class="chart-container">
                    <div class="chart-wrapper">
                        <canvas id="workerChart"></canvas>
                    </div>
                    <div class="chart-wrapper doughnutChart">
                        <canvas id="doughnutChart"></canvas>
                    </div>
                </div>
                <!-- Table -->
                <table id="workerTable">
                    <thead>
                        <tr>
                            <th>Position</th>
                            <th>Collaborateur</th>
                            <th>Total de palettes</th>
                            <th>Tâches (Palettes / 33)</th>
                            <th>Palettes déchargées</th>
                            <th>Palettes chargées</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            const ctxBar = document.getElementById('workerChart').getContext('2d');
            const ctxDoughnut = document.getElementById('doughnutChart').getContext('2d');
            let workerChart, doughnutChart;

            // Event listener for file input
            $('#fileInput').on('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    // Extract dates from the file name
                    const fileName = file.name;
                    const datePattern = /(\d{8})-(\d{8})/;
                    const dates = fileName.match(datePattern);

                    if (dates && dates.length >= 3) {
                        const startDate = formatDate(dates[1]);
                        const endDate = formatDate(dates[2]);
                        $('#dateRange').text(`Période: ${startDate} à ${endDate}`);
                    } else {
                        $('#dateRange').text('Période: Dates non trouvées dans le nom du fichier');
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // Assuming the first sheet is the one we need
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];

                        // Convert sheet to JSON
                        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                        // Process data
                        const workerTasks = {};

                        // Find indices of "Collaborateur entrepôt EM" and "Collaborateur entrepôt SM" columns
                        const headerRow = jsonData[0];
                        const emIndex = headerRow.indexOf("Collaborateur entrepôt EM");
                        const smIndex = headerRow.indexOf("Collaborateur entrepôt SM");

                        if (emIndex === -1 || smIndex === -1) {
                            alert('Columns "Collaborateur entrepôt EM" and "Collaborateur entrepôt SM" not found in the Excel file.');
                            return;
                        }

                        // Iterate through rows (skip header row)
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            const workerNameEM = row[emIndex]?.trim(); // Worker name in "Collaborateur entrepôt EM" column
                            const workerNameSM = row[smIndex]?.trim(); // Worker name in "Collaborateur entrepôt SM" column

                            // Count unloading tasks ("Collaborateur entrepôt EM" column)
                            if (workerNameEM) {
                                if (!workerTasks[workerNameEM]) {
                                    workerTasks[workerNameEM] = { unloading: 0, loading: 0 };
                                }
                                workerTasks[workerNameEM].unloading++;
                            }

                            // Count loading tasks ("Collaborateur entrepôt SM" column)
                            if (workerNameSM) {
                                if (!workerTasks[workerNameSM]) {
                                    workerTasks[workerNameSM] = { unloading: 0, loading: 0 };
                                }
                                workerTasks[workerNameSM].loading++;
                            }
                        }

                        // Calculate total tasks for each worker
                        const workers = Object.keys(workerTasks).map(name => {
                            const totalTasks = workerTasks[name].unloading + workerTasks[name].loading;
                            return {
                                name,
                                unloading: workerTasks[name].unloading,
                                loading: workerTasks[name].loading,
                                totalTasks,
                                trackers: Math.floor(totalTasks / 33) // Trackers = Total Pallets / 33
                            };
                        });

                        // Sort workers by total tasks (descending)
                        workers.sort((a, b) => b.totalTasks - a.totalTasks);

                        // Extract data for the bar chart
                        const labels = workers.map(worker => worker.name);
                        const unloadingData = workers.map(worker => worker.unloading);
                        const loadingData = workers.map(worker => worker.loading);

                        // Extract data for the doughnut chart
                        const doughnutLabels = workers.map(worker => worker.name);
                        const doughnutData = workers.map(worker => worker.totalTasks);

                        // Destroy existing charts if they exist
                        if (workerChart) {
                            workerChart.destroy();
                        }
                        if (doughnutChart) {
                            doughnutChart.destroy();
                        }

                        // Create a new stacked bar chart
                        workerChart = new Chart(ctxBar, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'Palettes déchargées',
                                        data: unloadingData,
                                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                        borderColor: 'rgba(255, 99, 132, 1)',
                                        borderWidth: 1
                                    },
                                    {
                                        label: 'Palettes chargées',
                                        data: loadingData,
                                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                        borderColor: 'rgba(54, 162, 235, 1)',
                                        borderWidth: 1
                                    }
                                ]
                            },
                            options: {
                                scales: {
                                    x: {
                                        stacked: true,
                                    },
                                    y: {
                                        stacked: true,
                                        beginAtZero: true
                                    }
                                }
                            }
                        });

                        // Create a new doughnut chart
                        doughnutChart = new Chart(ctxDoughnut, {
                            type: 'doughnut',
                            data: {
                                labels: doughnutLabels,
                                datasets: [{
                                    label: 'Total Palettes',
                                    data: doughnutData,
                                    backgroundColor: [
                                        'rgba(255, 99, 132, 0.6)',
                                        'rgba(54, 162, 235, 0.6)',
                                        'rgba(75, 192, 192, 0.6)',
                                        'rgba(153, 102, 255, 0.6)',
                                        'rgba(255, 159, 64, 0.6)'
                                    ],
                                    borderColor: [
                                        'rgba(255, 99, 132, 1)',
                                        'rgba(54, 162, 235, 1)',
                                        'rgba(75, 192, 192, 1)',
                                        'rgba(153, 102, 255, 1)',
                                        'rgba(255, 159, 64, 1)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                const value = context.raw || 0;
                                                const percentage = ((value / total) * 100).toFixed(2);
                                                return `${context.label}: ${value} Palettes (${percentage}%)`;
                                            }
                                        }
                                    }
                                }
                            }
                        });

                        // Populate the table
                        const tableBody = $('#workerTable tbody');
                        tableBody.empty();
                        workers.forEach((worker, index) => {
                            const row = `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${worker.name}</td>
                                    <td>${worker.totalTasks}</td>
                                    <td>${worker.trackers}</td>
                                    <td>${worker.unloading}</td>
                                    <td>${worker.loading}</td>
                                </tr>
                            `;
                            tableBody.append(row);
                        });
                    };
                    // Read the file as an array buffer
                    reader.readAsArrayBuffer(file);
                }
            });

            // Helper function to format date from "YYYYMMDD" to "DD/MM/YYYY"
            function formatDate(dateString) {
                const year = dateString.slice(0, 4);
                const month = dateString.slice(4, 6);
                const day = dateString.slice(6, 8);
                return `${day}/${month}/${year}`;
            }
        });
    </script>
</body>
</html>